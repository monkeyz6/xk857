<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RocketMQ | CV大魔王的笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="https://gzfhsw.oss-cn-guangzhou.aliyuncs.com/typora/2022/07/logo.png">
    <meta name="description" content="技术类笔记，在往全栈的路上努力奋斗，主攻java，擅长微服务。前端方面熟悉vue3，ts，uniapp，原生安卓。对设计模式有所了解，正在恶补数据结构和算法">
    
    <link rel="preload" href="/assets/css/0.styles.3b9c3e1f.css" as="style"><link rel="preload" href="/assets/js/app.1ff9bd4d.js" as="script"><link rel="preload" href="/assets/js/2.90eb1789.js" as="script"><link rel="preload" href="/assets/js/8.0b8839e5.js" as="script"><link rel="prefetch" href="/assets/js/10.a81a9f72.js"><link rel="prefetch" href="/assets/js/3.58e6395d.js"><link rel="prefetch" href="/assets/js/4.0f51aaa2.js"><link rel="prefetch" href="/assets/js/5.2908ac0d.js"><link rel="prefetch" href="/assets/js/6.ed1dacf6.js"><link rel="prefetch" href="/assets/js/7.f3199744.js"><link rel="prefetch" href="/assets/js/9.26c0883c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3b9c3e1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://gzfhsw.oss-cn-guangzhou.aliyuncs.com/typora/2022/07/logo.png" alt="CV大魔王的笔记" class="logo"> <span class="site-name">CV大魔王的笔记</span></a> <nav class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <ul class="nav-links can-hide"><li class="nav-item"><a href="/" class="nav-link"><!----> <span>首页</span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title">
      Java
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><!----> <span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/后端开发/通用/" class="nav-link"><!----> <span>后端开发(Java)</span></a></li><li class="dropdown-item"><!----> <a href="/后端开发/Redis/" class="nav-link"><!----> <span>Redis专栏</span></a></li></ul></div></li><li class="nav-item"><a href="/前端开发/" class="nav-link"><!----> <span>前端开发</span></a></li><li class="nav-item"><a href="/数据库/" class="nav-link"><!----> <span>数据库</span></a></li><li class="nav-item"><a href="/微服务专栏/" class="nav-link"><!----> <span>微服务专栏</span></a></li><li class="nav-item"><a href="/插件开发/" class="nav-link"><!----> <span>插件开发</span></a></li><li class="nav-item"><a href="/Spring专栏/" class="nav-link"><!----> <span>Spring专栏</span></a></li> <!----></ul> <div class="theme-switcher"><a class="switch light"><span><i aria-hidden="true" class="fa fa-sun"></i></span></a></div></nav></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <ul class="nav-links"><li class="nav-item"><a href="/" class="nav-link"><!----> <span>首页</span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title">
      Java
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><!----> <span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/后端开发/通用/" class="nav-link"><!----> <span>后端开发(Java)</span></a></li><li class="dropdown-item"><!----> <a href="/后端开发/Redis/" class="nav-link"><!----> <span>Redis专栏</span></a></li></ul></div></li><li class="nav-item"><a href="/前端开发/" class="nav-link"><!----> <span>前端开发</span></a></li><li class="nav-item"><a href="/数据库/" class="nav-link"><!----> <span>数据库</span></a></li><li class="nav-item"><a href="/微服务专栏/" class="nav-link"><!----> <span>微服务专栏</span></a></li><li class="nav-item"><a href="/插件开发/" class="nav-link"><!----> <span>插件开发</span></a></li><li class="nav-item"><a href="/Spring专栏/" class="nav-link"><!----> <span>Spring专栏</span></a></li> <!----></ul>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><i></i> <span>后端开发(Java)</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/后端开发/通用/java增效系列.html" class="sidebar-link">java高效编程常用技术优化手段</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/后端开发/通用/java增效系列.html#资源关闭优化方案" class="sidebar-link">资源关闭优化方案</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/java增效系列.html#jdk8新特性optional使用详解" class="sidebar-link">JDK8新特性Optional使用详解</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/java增效系列.html#拯救垃圾代码使用guava工具类" class="sidebar-link">拯救垃圾代码使用Guava工具类</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/java增效系列.html#multiset可重复无序集合" class="sidebar-link">Multiset可重复无序集合</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/java增效系列.html#集合工具类" class="sidebar-link">集合工具类</a></li></ul></li><li><a href="/后端开发/通用/lambda表达式.html" class="sidebar-link">JDK8新特性Lambda表达式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_0-自定义函数式接口" class="sidebar-link">0.自定义函数式接口</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_1-将接口用于方法参数" class="sidebar-link">1.将接口用于方法参数</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_2-jdk自带函数接口" class="sidebar-link">2.jdk自带函数接口</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_3-方法引用符" class="sidebar-link">3.方法引用符 ::</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_1-stream流创建操作" class="sidebar-link">1.Stream流创建操作</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_2-stream流中间操作" class="sidebar-link">2.Stream流中间操作</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_3-stream终止操作" class="sidebar-link">3.Stream终止操作</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_4-steam并行流" class="sidebar-link">4.Steam并行流</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/lambda表达式.html#_5-steam流收集器" class="sidebar-link">5.Steam流收集器</a></li></ul></li><li><a href="/后端开发/通用/RabbitMQ.html" class="sidebar-link">RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/后端开发/通用/RabbitMQ.html#对比当下主流的消息队列和选择问题" class="sidebar-link">对比当下主流的消息队列和选择问题</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RabbitMQ.html#rabbit使用docker方式进行安装" class="sidebar-link">Rabbit使用docker方式进行安装</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RabbitMQ.html#搭建rabbitmq普通集群" class="sidebar-link">搭建RabbitMQ普通集群</a></li></ul></li><li><a href="/后端开发/通用/RocketMQ.html" class="active sidebar-link">RocketMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#消息中间件常见概念和编程模型" class="sidebar-link">消息中间件常见概念和编程模型</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#rocketmq概述" class="sidebar-link">RocketMQ概述</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#rocketmq源码方式安装" class="sidebar-link">RocketMQ源码方式安装</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#rocketmq源码方式安装控制台" class="sidebar-link">RocketMQ源码方式安装控制台</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#rocketmq实战之发送消息" class="sidebar-link">RocketMQ实战之发送消息</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#rocketmq实战之接收消息" class="sidebar-link">RocketMQ实战之接收消息</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#rocketmq核心配置" class="sidebar-link">RocketMQ核心配置</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#消息常见发送状态" class="sidebar-link">消息常见发送状态</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#生产和消费消息重试及处理" class="sidebar-link">生产和消费消息重试及处理</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#rocketmq异步发送消息和回调" class="sidebar-link">RocketMQ异步发送消息和回调</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#oneway消息及多种场景对比" class="sidebar-link">OneWay消息及多种场景对比</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#延迟消息-电商应用场景" class="sidebar-link">延迟消息-电商应用场景</a></li><li class="sidebar-sub-header"><a href="/后端开发/通用/RocketMQ.html#生产者之messagequeueselector" class="sidebar-link">生产者之MessageQueueSelector</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-vpx-content content__default"><h1 id="rocketmq"><a href="#rocketmq" class="header-anchor">#</a> RocketMQ</h1> <h2 id="消息中间件常见概念和编程模型"><a href="#消息中间件常见概念和编程模型" class="header-anchor">#</a> 消息中间件常见概念和编程模型</h2> <ul><li>常见概念
<ul><li>JMS提供者：连接面向消息中间件的，JMS接口的一个实现，RocketMQ,ActiveMQ,Kafka等等</li> <li>JMS生产者(Message Producer)：生产消息的服务</li> <li>JMS消费者(Message Consumer)：消费消息的服务</li> <li>JMS消息：数据对象</li> <li>JMS队列：存储待消费消息的区域</li> <li>JMS主题：一种支持发送消息给多个订阅者的机制</li> <li>JMS消息通常有两种类型：点对点（Point-to-Point)、发布/订阅（Publish/Subscribe）</li></ul></li> <li>基础编程模型
<ul><li>MQ中需要用的一些类</li> <li>ConnectionFactory ：连接工厂，JMS 用它创建连接</li> <li>Connection ：JMS 客户端到JMS Provider 的连接</li> <li>Session： 一个发送或接收消息的线程</li> <li>Destination ：消息的目的地;消息发送给谁.</li> <li>MessageConsumer / MessageProducer： 消息消费者，消息生产者</li></ul></li></ul> <h2 id="rocketmq概述"><a href="#rocketmq概述" class="header-anchor">#</a> RocketMQ概述</h2> <ul><li><p>特点</p> <ul><li>支持Broker和Consumer端消息过滤</li> <li>支持发布订阅模型，和点对点，</li> <li>支持拉pull和推push两种消息模式</li> <li>单一队列百万消息、亿级消息堆积</li> <li>支持单master节点，多master节点，多master多slave节点</li> <li>任意一点都是高可用，水平拓展，Producer、Consumer、队列都可以分布式</li> <li>消息失败重试机制、支持特定level的定时消息</li> <li>新版本底层采用Netty</li> <li>4.3.x支持分布式事务</li> <li>适合金融类业务，高可用性跟踪和审计功能。</li></ul></li> <li><p>概念</p> <ul><li><p>Producer:消息生产者</p></li> <li><p>Producer Group:消息生产者组，发送同类消息的一个消息生产组</p></li> <li><p>Consumer:消费者</p></li> <li><p>Consumer Group:消费同类消息的多个实例</p></li> <li><p>Tag:标签，子主题（二级分类）对topic的进一步细化,用于区分同一个主题下的不同业务的消息</p></li> <li><p>Topic:主题, 如订单类消息，queue是消息的物理管理单位，而topic是逻辑管理单位。一个topic下可以有多个queue，</p> <p>默认自动创建是4个，手动创建是8个</p></li> <li><p>Message：消息,每个message必须指定一个topic</p></li> <li><p>Broker：MQ程序，接收生产的消息，提供给消费者消费的程序</p></li> <li><p>Name Server：给生产和消费者提供路由信息，提供轻量级的服务发现、路由、元数据信息，可以多个部署，互相独立（比zookeeper更轻量）</p></li> <li><p>Offset: 偏移量，可以理解为消息进度</p></li> <li><p>commit log: 消息存储会写在Commit log文件里面</p></li></ul></li></ul> <h2 id="rocketmq源码方式安装"><a href="#rocketmq源码方式安装" class="header-anchor">#</a> RocketMQ源码方式安装</h2> <h3 id="centos7安装jdk8"><a href="#centos7安装jdk8" class="header-anchor">#</a> centos7安装JDK8</h3> <p>官网下载linux.tar.gz版本，上传至云服务器 /usr/local/software/ 目录下</p> <p>点击下载https://xk857.com/t/jdk-8u201-linux-x64.tar.gz</p> <div class="language-shell extra-class"><pre class="language-shell"><code>解压：tar -zxvf jdk-8u201-linux-x64.tar.gz
重命名：mv jdk1.8.0_201 jdk8
<span class="token function">vim</span> /etc/profile
加入
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/local/software/jdk8
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jar
<span class="token builtin class-name">export</span> JAVA_HOME <span class="token environment constant">PATH</span> CLASSPATH
使用 <span class="token builtin class-name">source</span> /etc/profile   让配置立刻生效
</code></pre></div><h3 id="linux服务器下安装maven"><a href="#linux服务器下安装maven" class="header-anchor">#</a> Linux服务器下安装Maven</h3> <p>点击下载：https://xk857.com/t/apache-maven-3.6.0-bin.tar.gz，上传至 /usr/local/software/ 目录下</p> <div class="language-shell extra-class"><pre class="language-shell"><code>解压：tar -zxvf apache-maven-3.6.0-bin.tar.gz
重命名： <span class="token function">mv</span> apache-maven-3.6.0 maven
<span class="token function">vim</span> /etc/profile
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/software/maven/bin:<span class="token environment constant">$PATH</span>

立刻生效：source /etc/profile
查看版本： mvn -v
</code></pre></div><h3 id="linux服务器下源码部署rocketmq4-x"><a href="#linux服务器下源码部署rocketmq4-x" class="header-anchor">#</a> Linux服务器下源码部署RocketMQ4.X</h3> <p>进入官网，点击进行下载，<a href="https://rocketmq.apache.org/docs/quick-start/" target="_blank" rel="noopener noreferrer">Quick Start - Apache RocketMQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://xk857.com/typora/2021/05image-20210526103741006.png" alt="image-20210526103741006"></p> <p>第二步，点击下载</p> <p><img src="https://xk857.com/typora/2021/05image-20210526103819998.png" alt="image-20210526103819998"></p> <p>直接下载：https://xk857.com/t/rocketmq-all-4.8.0-source-release.zip</p> <p>上传至 /usr/local/software/</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Liunx 解压安装</span>
yum <span class="token function">install</span> <span class="token function">unzip</span> 
<span class="token comment"># 解压</span>
<span class="token function">unzip</span> rocketmq-all-4.8.0-source-release.zip
<span class="token comment"># 重命名</span>
<span class="token function">mv</span> rocketmq-all-4.8.0-source-release rocketmq


<span class="token builtin class-name">cd</span> rocketmq
mvn -Prelease-all -DskipTests clean <span class="token function">install</span> -U
<span class="token builtin class-name">cd</span> distribution/target/rocketmq-4.8.0/rocketmq-4.8.0
</code></pre></div><p>启动</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/local/software/rocketmq/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/

启动 mqnamesrv
<span class="token function">nohup</span> <span class="token function">sh</span> bin/mqnamesrv <span class="token operator">&amp;</span>
<span class="token function">tail</span> -f ~/logs/rocketmqlogs/namesrv.lo

启动 broker
</code></pre></div><p>可能会出现报错，下面列出解决方案。</p> <p>内存不够怎么处理? 找到 runserver.sh 修改 JAVA_OPT</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/local/software/rocketmq/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/
<span class="token function">vim</span> bin/runserver.hs

进入后修改：
<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -server -Xms1g -Xmx1g -Xmn512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span>
</code></pre></div><p><img src="https://xk857.com/typora/2021/05image-20210526114831424.png" alt="image-20210526114831424"></p> <p>broker内存不足解决办法</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/local/software/rocketmq/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/
<span class="token function">vim</span> bin/runbroker.sh

修改配置
<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -server -Xms1g -Xmx1g -Xmn512m&quot;</span>
</code></pre></div><p><img src="https://xk857.com/typora/2021/05image-20210526120235989.png" alt="image-20210526120235989"></p> <p>验证</p> <div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">NAMESRV_ADDR</span><span class="token operator">=</span>localhost:9876
 <span class="token operator">&gt;</span> <span class="token function">sh</span> bin/tools.sh org.apache.rocketmq.example.quickstart.Producer SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK, <span class="token assign-left variable">msgId</span><span class="token operator">=</span> <span class="token punctuation">..</span>.
 <span class="token operator">&gt;</span> <span class="token function">sh</span> bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer ConsumeMessageThread_%d Receive New Messages: <span class="token punctuation">[</span>MessageExt<span class="token punctuation">..</span>.
</code></pre></div><h2 id="rocketmq源码方式安装控制台"><a href="#rocketmq源码方式安装控制台" class="header-anchor">#</a> RocketMQ源码方式安装控制台</h2> <p>下载地址：https://github.com/apache/rocketmq-externals</p> <p>码云同步访问仓库：https://gitee.com/monkeyz6/rocketmq-externals.git</p> <p>将下载后的zip文件，上传到 /usr/local/software/ ，下面的命令文件名可能有所差异，注意辨别</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/local/software/
解压
<span class="token function">unzip</span> monkeyz6-rocketmq-externals-master.zip
<span class="token builtin class-name">cd</span> rocketmq-externals
<span class="token builtin class-name">cd</span> rocketmq-console
 
<span class="token comment"># 修改 applicatiuon.properties</span>
<span class="token builtin class-name">cd</span> /usr/local/software/rocketmq-externals/rocketmq-console/src/main/resources
<span class="token function">vim</span> application.properties
<span class="token comment"># 设置地址</span>
rocketmq.config.namesrvAddr<span class="token operator">=</span><span class="token number">127.0</span>.0.1:9876

<span class="token builtin class-name">cd</span> /usr/local/software/rocketmq-externals/rocketmq-console/
编译打包
mvn clean package -Dmaven.test.skip<span class="token operator">=</span>true
<span class="token builtin class-name">cd</span> target/
</code></pre></div><ul><li>进入target目录 ，启动 java -jar rocketmq-console-ng-2.0.0.jar</li> <li>守护进程方式启动  nohup java -jar rocketmq-console-ng-2.0.0.jar &amp;</li></ul> <p>默认8080端口，访问：ip:8080</p> <h1 id="springboot整合rocketmq入门实战"><a href="#springboot整合rocketmq入门实战" class="header-anchor">#</a> SpringBoot整合RocketMQ入门实战</h1> <h2 id="rocketmq实战之发送消息"><a href="#rocketmq实战之发送消息" class="header-anchor">#</a> RocketMQ实战之发送消息</h2> <p>先开启防火墙端口，10909、8080、10911、9876</p> <p>搭建 SpringBoot 项目，并加入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>创建 com.example.rocketmq.jms.PayProducer</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> producerGroup <span class="token operator">=</span> <span class="token string">&quot;pay_group&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> nameServerAddr <span class="token operator">=</span> <span class="token string">&quot;1.15.143.246:9876&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">DefaultMQProducer</span> producer<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PayProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span>producerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>nameServerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultMQProducer</span> <span class="token function">getProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>producer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 对象在使用前必须调用一次，只能初始化一次
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 一般在应用上下文，使用上下文监听器，进行关闭
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建接口 com.example.rocketmq.controller.PayController</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">PayProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">MQBrokerException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">MQClientException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">SendResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">RemotingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author cv大魔王
 * @version 1.0
 * @date 2021/5/26 14:08
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/pay&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PayProducer</span> payProducer<span class="token punctuation">;</span>

    <span class="token comment">// 主题</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">&quot;pay_test_topic&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/pay_cb&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">&quot;tag1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;Hello rocketmq = &quot;</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发送消息</span>
            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> payProducer<span class="token punctuation">.</span><span class="token function">getProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQBrokerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="常见错误"><a href="#常见错误" class="header-anchor">#</a> 常见错误</h3> <p>常见错误一</p> <blockquote><p>org.apache.rocketmq.remoting.exception.RemotingTooMuchRequestException:sendDefaultImpl call timeout
原因：阿里云/腾讯云存在多网卡，rocketmq都会根据当前网卡选择一个IP使用，当你的机器有多块网卡时，很有可能会有问题。</p> <p>比如，我遇到的问题是我机器上有两个IP，一个公网IP，一个私网IP, 因此需要配置broker.conf 指定当前的公网ip, 然后重新启动broker
新增配置：conf/broker.conf  (属性名称brokerIP1=broker所在的公网ip地址 )
新增这个配置：brokerIP1=120.76.62.13</p> <p>启动命令：nohup sh bin/mqbroker -n localhost:9876  -c ./conf/broker.conf &amp;</p></blockquote> <p>具体解决：</p> <p>org.apache.rocketmq.remoting.exception.RemotingTooMuchRequestException: sendDefaultImpl call timeout</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/local/software/rocketmq/distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/conf
<span class="token function">vim</span> broker.conf

增加配置
<span class="token assign-left variable">brokerIP1</span><span class="token operator">=</span>公网IP

保存后关闭进程
<span class="token punctuation">[</span>root@VM-4-16-centos conf<span class="token punctuation">]</span><span class="token comment"># jps</span>
<span class="token number">8578</span> jar
<span class="token number">20692</span> Jps
<span class="token number">26296</span> NamesrvStartup
<span class="token number">26346</span> BrokerStartup
<span class="token punctuation">[</span>root@VM-4-16-centos conf<span class="token punctuation">]</span><span class="token comment"># kill -9 26346</span>
<span class="token punctuation">[</span>root@VM-4-16-centos conf<span class="token punctuation">]</span><span class="token comment"># cd ..</span>


<span class="token punctuation">[</span>root@VM-4-16-centos rocketmq-4.8.0<span class="token punctuation">]</span><span class="token comment"># sh bin/mqbroker -n localhost:9876  -c ./conf/broker.conf</span>
The broker<span class="token punctuation">[</span>broker-a, <span class="token number">1.15</span>.143.246:10911<span class="token punctuation">]</span> boot success. <span class="token assign-left variable">serializeType</span><span class="token operator">=</span>JSON and name server is localhost:9876
</code></pre></div><p>常见错误二</p> <div class="language- extra-class"><pre class="language-text"><code>MQClientException: No route info of this topic, TopicTest1
原因：Broker 禁止自动创建 Topic，且用户没有通过手工方式创建 此Topic, 或者broker和Nameserver网络不通
解决：
通过 sh bin/mqbroker -m  查看配置
autoCreateTopicEnable=true 则自动创建topic

Centos7关闭防火墙  systemctl stop firewalld
</code></pre></div><p>常见错误三</p> <div class="language- extra-class"><pre class="language-text"><code>控制台查看不了数据，提示连接 10909错误

原因：Rocket默认开启了VIP通道，VIP通道端口为10911-2=10909

解决：阿里云安全组需要增加一个端口 10909
</code></pre></div><p>其他错误:</p> <div class="language- extra-class"><pre class="language-text"><code>https://blog.csdn.net/qq_14853889/article/details/81053145
https://blog.csdn.net/wangmx1993328/article/details/81588217#%E5%BC%82%E5%B8%B8%E8%AF%B4%E6%98%8E
https://www.jianshu.com/p/bfd6d849f156
https://blog.csdn.net/wangmx1993328/article/details/81588217
</code></pre></div><h2 id="rocketmq实战之接收消息"><a href="#rocketmq实战之接收消息" class="header-anchor">#</a> RocketMQ实战之接收消息</h2> <p>将配置简单提取一下：com.example.rocketmq.jms.JmsConfig</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JmsConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME_SERVER <span class="token operator">=</span> <span class="token string">&quot;1.15.143.246:9876&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC <span class="token operator">=</span> <span class="token string">&quot;pay_test_topic&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>消费消息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayConsumer</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 接收消息对象
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">DefaultMQPushConsumer</span> consumer<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> consumerGroup <span class="token operator">=</span> <span class="token string">&quot;pay_consumer_group&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PayConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>

        consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">.</span>NAME_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> msg <span class="token operator">=</span> msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s Receive New Messages: %s %n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> keys <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;topic=&quot;</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">&quot;, tags=&quot;</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">&quot;, keys=&quot;</span> <span class="token operator">+</span> keys <span class="token operator">+</span> <span class="token string">&quot;, msg=&quot;</span> <span class="token operator">+</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumer start ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="rocketmq核心配置"><a href="#rocketmq核心配置" class="header-anchor">#</a> RocketMQ核心配置</h2> <p>生产者常见核心配置</p> <ul><li>compressMsgBodyOverHowmuch ：消息超过默认字节4096后进行压缩</li> <li>retryTimesWhenSendFailed : 失败重发次数</li> <li>maxMessageSize : 最大消息配置，默认128k</li> <li>topicQueueNums : 主题下面的队列数量，默认是4</li> <li>autoCreateTopicEnable : 是否自动创建主题Topic, 开发建议为true，生产要为false</li> <li>defaultTopicQueueNums : 自动创建服务器不存在的topic，默认创建的队列数</li> <li>autoCreateSubscriptionGroup: 是否允许 Broker 自动创建订阅组，建议线下开发开启，线上关闭</li> <li>brokerClusterName : 集群名称</li> <li>brokerId : 0表示Master主节点 大于0表示从节点</li> <li>brokerIP1 : Broker服务地址</li> <li>brokerRole : broker角色 ASYNC_MASTER/ SYNC_MASTER/ SLAVE</li> <li>deleteWhen : 每天执行删除过期文件的时间，默认每天凌晨4点</li> <li>flushDiskType ：刷盘策略, 默认为 ASYNC_FLUSH(异步刷盘), 另外是SYNC_FLUSH(同步刷盘)</li> <li>listenPort ： Broker监听的端口号</li> <li>mapedFileSizeCommitLog ： 单个conmmitlog文件大小，默认是1GB</li> <li>mapedFileSizeConsumeQueue：ConsumeQueue每个文件默认存30W条，可以根据项目调整</li> <li>storePathRootDir : 存储消息以及一些配置信息的根目录 默认为用户的 ${HOME}/store</li> <li>storePathCommitLog：commitlog存储目录默认为${storePathRootDir}/commitlog</li> <li>storePathIndex： 消息索引存储路径</li> <li>syncFlushTimeout : 同步刷盘超时时间</li> <li>diskMaxUsedSpaceRatio ： 检测可用的磁盘空间大小，超过后会写入报错</li></ul> <h2 id="消息常见发送状态"><a href="#消息常见发送状态" class="header-anchor">#</a> 消息常见发送状态</h2> <ul><li>消息发送有同步和异步</li></ul> <blockquote><p>Broker消息投递状态</p> <ul><li>FLUSH_DISK_TIMEOUT：没有在规定时间内完成刷盘 (刷盘策略需要为SYNC_FLUSH 才会出这个错误)</li> <li>FLUSH_SLAVE_TIMEOUT：主从模式下，broker是SYNC_MASTER, 没有在规定时间内完成主从同步</li> <li>SLAVE_NOT_AVAILABLE：从模式下，broker是SYNC_MASTER, 但是没有找到被配置成Slave的Broker</li> <li>SEND_OK：发送成功，没有发生上面的三种问题</li></ul></blockquote> <h2 id="生产和消费消息重试及处理"><a href="#生产和消费消息重试及处理" class="header-anchor">#</a> 生产和消费消息重试及处理</h2> <p>生产者Producer重试（异步和SendOneWay下配置无效）</p> <ul><li>消息重投(保证数据的高可靠性),本身内部支持重试，默认次数是2，</li> <li>如果网络情况比较差，或者跨集群则建改多几次</li></ul> <p>com.example.rocketmq.jms.PayProducer</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> producerGroup <span class="token operator">=</span> <span class="token string">&quot;pay_group&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">DefaultMQProducer</span> producer<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PayProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span>producerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生产者投递消息重试次数</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendFailed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">.</span>NAME_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>com.example.rocketmq.controller.PayController</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/pay&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PayProducer</span> payProducer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/pay_cb&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
        <span class="token comment">// key是唯一的，一般是订单号等，这里仅做测试，生产者根据key进行消息重投，默认次数为2</span>
        <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span> <span class="token string">&quot;tag1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1234&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;Hello rocketmq = &quot;</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送消息</span>
        <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> payProducer<span class="token punctuation">.</span><span class="token function">getProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>消费端重试</p> <ul><li>原因：消息处理异常、broker端到consumer端各种问题，如网络原因闪断，消费处理失败，ACK返回失败等问题。</li></ul> <p>注意：</p> <ul><li><p>重试间隔时间配置 ,默认每条消息最多重试 16 次</p> <p><code>messageDelayLevel=1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</code></p></li> <li><p>超过重试次数人工补偿</p></li> <li><p>消费端去重</p></li> <li><p>一条消息无论重试多少次，这些重试消息的 Message ID，key 不会改变。</p></li> <li><p>消费重试只针对集群消费方式生效；广播方式不提供失败重试特性，即消费失败后，失败消息不再重试，继续消费新的消息，</p></li></ul> <p>com.example.rocketmq.jms.PayConsumer</p> <p><img src="https://xk857.com/typora/2021/05image-20210527093040432.png" alt=""></p> <h2 id="rocketmq异步发送消息和回调"><a href="#rocketmq异步发送消息和回调" class="header-anchor">#</a> RocketMQ异步发送消息和回调</h2> <p>核心代码</p> <div class="language-java extra-class"><pre class="language-java"><code>producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">onException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>发送异步消息</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/async&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">asyncMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token comment">// key是唯一的，一般是订单号等，这里仅做测试，生产者根据key进行消息重投，默认次数为2</span>
    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span> <span class="token string">&quot;tag1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1234&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;Hello rocketmq = &quot;</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payProducer<span class="token punctuation">.</span><span class="token function">getProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;发送结果 %s， msg=%s&quot;</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//补偿机制，根据业务情况查看是否需要进行重试</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="oneway消息及多种场景对比"><a href="#oneway消息及多种场景对比" class="header-anchor">#</a> OneWay消息及多种场景对比</h2> <ul><li><p>SYNC ：</p> <p>应用场景：重要通知邮件、报名短信通知、营销短信系统等</p></li> <li><p>ASYNC ：异步</p> <p>应用场景：对RT时间敏感，可以支持更高的并发，回调成功触发相对应的业务，比如注册成功后通知积分系统发放优惠券</p></li> <li><p>ONEWAY : 无需要等待响应</p> <p>使用场景：主要是日志收集，适用于某些耗时非常短，但对可靠性要求并不高的场景, 也就是LogServer, 只负责发送消息，不等待<a href="https://www.baidu.com/s?wd=%E6%9C%8D%E5%8A%A1%E5%99%A8&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener noreferrer">服务器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>回应且没有回调函数触发，即只发送请求不等待应答</p></li></ul> <table><thead><tr><th style="text-align:left;">发送方式</th> <th style="text-align:left;">发送 TPS</th> <th style="text-align:left;">发送结果反馈</th> <th style="text-align:left;">可靠性</th></tr></thead> <tbody><tr><td style="text-align:left;">同步发送</td> <td style="text-align:left;">快</td> <td style="text-align:left;">有</td> <td style="text-align:left;">不丢失</td></tr> <tr><td style="text-align:left;">异步发送</td> <td style="text-align:left;">快</td> <td style="text-align:left;">有</td> <td style="text-align:left;">不丢失</td></tr> <tr><td style="text-align:left;">单向发送</td> <td style="text-align:left;">最快</td> <td style="text-align:left;">无</td> <td style="text-align:left;">可能丢失</td></tr></tbody></table> <p>发送OneWay消息</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/async&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendOnWayMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span> <span class="token string">&quot;tag1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1234&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;Hello rocketmq = &quot;</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payProducer<span class="token punctuation">.</span><span class="token function">getProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="延迟消息-电商应用场景"><a href="#延迟消息-电商应用场景" class="header-anchor">#</a> 延迟消息-电商应用场景</h2> <p>什么是延迟消息：</p> <ul><li><p>Producer 将消息发送到消息队列 RocketMQ 服务端，但并不期望这条消息立马投递，而是推迟到在当前时间点之后的某一个时间投递到 Consumer 进行消费，该消息即定时消息，目前支持固定精度的消息</p></li> <li><p>源码：rocketmq-store &gt; MessageStoreConfig.java 属性 messageDelayLevel</p> <p><code>&quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;;</code></p></li> <li><p>使用message.setDelayTimeLevel(xxx) //xxx是级别，1表示配置里面的第一个级别，2表示第二个级别</p></li></ul> <p>使用场景</p> <ul><li>通过消息触发一些定时任务，比如在某一固定时间点向用户发送提醒消息</li> <li>消息生产和消费有时间窗口要求：比如在天猫电商交易中超时未支付关闭订单的场景，在订单创建时会发送一条 延时消息。这条消息将会在 30 分钟以后投递给消费者，消费者收到此消息后需要判断对应的订单是否已完成支付。 如支付未完成，则关闭订单。如已完成支付则忽略</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/delay&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">delayMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token comment">// key是唯一的，一般是订单号等，这里仅做测试，生产者根据key进行消息重投，默认次数为2</span>
    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span> <span class="token string">&quot;tag1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1234&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;Hello rocketmq = &quot;</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5s后被消费</span>
    message<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    payProducer<span class="token punctuation">.</span><span class="token function">getProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;发送结果 %s， msg=%s&quot;</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//补偿机制，根据业务情况查看是否需要进行重试</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="生产者之messagequeueselector"><a href="#生产者之messagequeueselector" class="header-anchor">#</a> 生产者之MessageQueueSelector</h2> <p><strong>生产消息使用MessageQueueSelector投递到Topic下指定的queue，</strong></p> <p>应用场景：顺序消息，分摊负载</p> <p>默认topic下的queue数量是4，可以配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//可以使用Jdk8的lambda表达式，只有一个方法需要被实现</span>
producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> queueNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
        <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>queueNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p>支持同步，异步发送指定的MessageQueue</p> <p>选择的queue数量必须小于配置的，否则会出错</p></div> <!----> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/后端开发/通用/RabbitMQ.html" class="prev">
        RabbitMQ
      </a></span> <!----></p></div> <div class="page-footer"><ul class="inner"><li>Theme by <a href="https://gitee.com/qcyblm/vuepress-theme-vpx" title="本站主题" target="_blank" rel="noopener noreferrer">VPX</a></li> <li>Powered by <a href="https://www.vuepress.cn/" target="_blank" rel="noopener noreferrer">VuePress</a></li> <!----> <li>
      © 2020-2022
       cv大魔王 </li> <li><a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank" rel="noopener noreferrer"><!---->  皖ICP备20012269号-1
      </a></li> </ul></div> </main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1ff9bd4d.js" defer></script><script src="/assets/js/2.90eb1789.js" defer></script><script src="/assets/js/8.0b8839e5.js" defer></script>
  </body>
</html>
